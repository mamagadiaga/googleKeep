<script>
    
// Contenu
let notesArray = [];
let archiveArray = [];
let trashArray = [];


$(document).ready(function () {

  // Edit
  $("#" + id).find(".edit-note").click(function (event) {
    event.stopPropagation();

    let note = notesArray.find(note => note.Index === id);

    $("#edit-title").val(note.Title);
    $("#edit-content").val(note.Content);

    openEditModal();

    $("#saveEdit").off("click").on("click", function () {
      let editedTitle = $("#edit-title").val();
      let editedContent = $("#edit-content").val();

      notesArray.push({
        Index: id,
        Color: note.BackgroundColor,
        Title: editedTitle,
        Content: editedContent,
        BackgroundColor: note.BackgroundColor,
        ImageURL: note.ImageURL,
      });

      updateLocalStorageAndUI();

      closeEditModal();
    });
  });

  $("#save_change").click(function () {
    saveEdit();
  });

});


function updateLocalStorageAndUI() {
  let jsonStr = JSON.stringify(notesArray);
  localStorage.setItem("notes", jsonStr);
  updateNotes();
}

// Notes
function addNewNote(id, color, title, content, labels) {
  let notes = $(".notes");
  let noteTemplate = `
  <div class="notes-content" id="${id}" style="background-color:${color}">
         <div class="card-container">
           ${imageURL ? `<img src="${imageURL}" alt="Image preview">` : ''}
           <h4 class="note-title" style="padding: 20px; padding-bottom: 0">${title}</h4>
           <p style="padding-left: 20px;">${content}</p>
           <div class="labels-container" id="labels-${id}"></div> <!-- Labels container -->
         </div>
         <div class="note-actions">
           <a href="#" class="delete-note"><i class="material-icons">delete</i></a>
           <a href="#" class="archive-note"><i class="material-icons">archive</i></a>
           <a href="#" class="edit-note"><i class="material-icons">edit</i></a>
         </div>
       </div>
  `;

  notes.append(noteTemplate);

  let labelsContainer = $(`#labels-${id}`);
  labels.forEach(label => {
    labelsContainer.append(`<span class="label clickable">${label}</span>`);
  });

  $("#" + id).find(".edit-note").click(function (event) {
    event.stopPropagation();

    openEditModal(id);
  });
}

function updateNotes() {
  let notes = $(".notes");
  notes.empty();

  for (let i = 0; i < notesArray.length; i++) {
    let note = notesArray[i];
    addNewNote(
      note.Index,
      note.Color,
      note.Title,
      note.Content,
      note.Labels
    );
  }
}

$("#save_note").click(function () {
  let title = $("#input-title").val();
  let content = $("#input-feild").val();
  let bgColor = $("#colorPicker").val();
  let index = "colour" + Math.ceil(Math.random() * 3);

  if (title !== "" || content !== "") {
    let labels = [];
    $("#task-list li label").each(function () {
      labels.push($(this).text());
    });

    notesArray.push({
      Index: index,
      Color: bgColor,
      Title: title,
      Content: content,
      Labels: labels,
    });

    addNewNote(index, bgColor, title, content, labels);

    // Vider les champs
    $("#input-title").val("");
    $("#input-feild").val("");
    $("#colorPicker").val("#ffffff");
  }
});






// Archive
$(".notes").on("click", ".archive-note", function () {
  let note = $(this).closest(".notes-content");
  let noteIndex = note.attr("id");

  let archivedNote = notesArray.find(note => note.Index === noteIndex);
  archiveArray.push(archivedNote);

  notesArray = notesArray.filter(note => note.Index !== noteIndex);
  updateNotes();
  updateArchive(); 
});


function updateArchive() {
  let archive = $(".archive");
  archive.empty();

  for (let i = 0; i < archiveArray.length; i++) {
    let archivedNote = archiveArray[i];
    addArchivedNote(
      archivedNote.Index,
      archivedNote.Color,
      archivedNote.Title,
      archivedNote.Content,
      archivedNote.Labels
    );
  }
}

function addArchivedNote(id, color, title, content, labels) {
  let archive = $(".archive");
  let archiveTemplate = `
    <div class="notes-content" id="${id}" style="background-color:${color}">
    <div class="card-container">
      ${imageURL ? `<img src="${imageURL}" alt="Image preview">` : ''}
      <h4 class="note-title" style="padding: 20px; padding-bottom: 0">${title}</h4>
      <p style="padding-left: 20px;">${content}</p>
      <div class="labels-container" id="labels-${id}"></div> <!-- Labels container -->
    </div>
    <div class="note-actions">
    <a href="#" class="delete-archive-note"><i class="material-icons">delete</i></a>
    <a href="#" class="restore-archive-note"><i class="material-icons">restore</i></a>
    </div>
  </div>
  `;
  archive.append(archiveTemplate);

  let labelsContainer = $(`#labels-${id}`);
  labels.forEach(label => {
    labelsContainer.append(`<span class="label clickable">${label}</span>`);
  });
  
  $("#" + id).find(".delete-archive-note").click(function () {
    let noteIndex = $(this).closest(".notes-content").attr("id");
    archiveArray = archiveArray.filter(note => note.Index !== noteIndex);
    updateArchive();
  });

  $("#" + id).find(".restore-archive-note").click(function () {
    let noteIndex = $(this).closest(".notes-content").attr("id");
    let restoredNote = archiveArray.find(note => note.Index === noteIndex);
    notesArray.push(restoredNote);
    archiveArray = archiveArray.filter(note => note.Index !== noteIndex);
    updateNotes();
    updateArchive();
  });

}

function openEditModal(id) {
  let note = notesArray.find(note => note.Index === id);
  $("#edit-title").val(note.Title);
  $("#edit-content").val(note.Content);
  $("#editModal").data("note-id", id);
  $("#editModal").show();
}

function saveEdit() {
  let editedTitle = $("#edit-title").val();
  let editedContent = $("#edit-content").val();

  let id = $("#editModal").data("note-id");

  let noteIndex = notesArray.findIndex(note => note.Index === id);
  if (noteIndex !== -1) {
    notesArray[noteIndex].Title = editedTitle;
    notesArray[noteIndex].Content = editedContent;
  }

  updateLocalStorageAndUI();

  closeEditModal();
}


// Delete
$(".notes").on("click", ".delete-note", function () {
  let note = $(this).closest(".notes-content");
  let noteIndex = note.attr("id");

  let deletedNote = notesArray.find(note => note.Index === noteIndex);
  trashArray.push(deletedNote);

  notesArray = notesArray.filter(note => note.Index !== noteIndex);
  updateNotes();
  updateTrash();
});

function updateTrash() {
  let trash = $("#corbeille-notes");
  trash.empty();

  for (let i = 0; i < trashArray.length; i++) {
    let deletedNote = trashArray[i];
    addDeletedNote(deletedNote.Index, deletedNote.Color, deletedNote.Title, deletedNote.Content, deletedNote.Labels);
  }
}


function addDeletedNote(id, color, title, content, labels) {
  let trash = $("#corbeille-notes");
  let trashTemplate = `
    <div class="notes-content" id="${id}" style="background-color:${color}">
      <!-- Structure HTML pour afficher une note dans la corbeille -->
      <div class="card-container">
        <h4 class="note-title" style="padding: 20px; padding-bottom: 0">${title}</h4>
        <p style="padding-left: 20px;">${content}</p>
        <div class="labels-container" id="labels-${id}"></div>
      </div>
      <div class="note-actions">
        <a href="#" class="restore-trash-note"><i class="material-icons">restore</i></a>
        <a href="#" class="delete-trash-note"><i class="material-icons">delete</i></a>
      </div>
    </div>
  `;
  trash.append(trashTemplate);

  $("#" + id).find(".restore-trash-note").click(function () {
    restoreNoteFromTrash(id);
  });

  $("#" + id).find(".delete-trash-note").click(function () {
    deleteNoteFromTrash(id);
  });

  let labelsContainer = $(`#labels-${id}`);
  labels.forEach(label => {
    labelsContainer.append(`<span class="label clickable">${label}</span>`);
  });
}

$("#" + id).find(".delete-note").click(function () {
  let noteIndex = $(this).closest(".notes-content").attr("id");

  let deletedNote = notesArray.find(note => note.Index === noteIndex);
  trashArray.push(deletedNote);

  notesArray = notesArray.filter(note => note.Index !== noteIndex);
  updateNotes();
  updateTrash();
});


function restoreNoteFromTrash(id) {
  let restoredNote = trashArray.find(note => note.Index === id);
  notesArray.push(restoredNote);
  trashArray = trashArray.filter(note => note.Index !== id);
  updateNotes();
  updateTrash();
}

function deleteNoteFromTrash(id) {
  trashArray = trashArray.filter(note => note.Index !== id);
  updateTrash();
}

</script>